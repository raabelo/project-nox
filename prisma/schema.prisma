generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  PLAYER_CHARACTER
  DUNGEON_MASTER
}

enum LoreObjectType {
  LOCATION
  ITEM
  NPC
  EVENT
  PLAYER_CHARACTER
}

enum AddonType {
  CORE
  RULES
  PROMPT
  NARRATIVE
  INTEGRATION
  UTILITY
}

model Account {
  id String @id @default(cuid())

  type              String
  provider          String
  providerAccountId String
  refreshToken      String? @map("refresh_token")
  accessToken       String? @map("access_token")
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token")
  sessionState      String? @map("session_state")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([provider, providerAccountId])
}

model Session {
  id String @id @default(cuid())

  sessionToken String   @unique
  expires      DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id String @id @default(cuid())

  email    String  @unique
  password String
  nickname String  @unique
  avatar   String?

  characters PlayerCharacter[]
  addons     Addon[]

  accounts Account[]
  sessions Session[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model Game {
  id String @id @default(cuid())

  title            String
  thumbnail        String?
  description      String?
  backgroundStory  String?
  shortTermSummary String?
  longTermSummary  String?
  isPrivate        Boolean? @default(false)

  characters  PlayerCharacter[]
  memories    Memory[]
  loreObjects LoreObject[]
  dialogs     DialogMessage[]

  addons Addon[]

  summaryUpdatedAt DateTime @default(now())

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model PlayerCharacter {
  id String @id @default(cuid())

  name    String
  uiColor String?
  picture String?

  user   User   @relation(fields: [userId], references: [id])
  userId String
  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  memories Memory[]
  dialogs  DialogMessage[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model Memory {
  id String @id @default(cuid())

  name      String
  content   String
  embedding String?

  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  characters  PlayerCharacter[]
  loreObjects LoreObject[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model LoreObject {
  id String @id @default(cuid())

  type        LoreObjectType
  name        String
  description String?
  picture     String?

  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  memories Memory[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model DialogMessage {
  id String @id @default(cuid())

  message   String
  role      Role
  embedding String?

  character   PlayerCharacter? @relation(fields: [characterId], references: [id])
  characterId String?
  game        Game             @relation(fields: [gameId], references: [id])
  gameId      String

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model Addon {
  id String @id @default(cuid())

  repositoryUrl String
  slug          String?     @unique
  name          String?
  version       String?
  description   String?
  thumbnail     String?
  tags          String[]
  types         AddonType[]
  verified      Boolean     @default(false)

  games Game[]

  author   User   @relation(fields: [authorid], references: [id])
  authorid String

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}
